<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Search</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #121212;
            margin: 0;
            padding: 0;
            color: #ffffff;
        }
        .header {
            background-color: #1db954;
            padding: 20px;
            color: whit<e;
            text-align: center;
            position: relative;
        }
        .search-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        .search-container input[type="text"] {
            width: 50%;
            padding: 15px;
            font-size: 16px;
            border: none;
            border-radius: 30px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            outline: none;
            color: #ffffff; /* Text color */
            background-color: #333333; /* Background color */
        }
        .search-container input[type="text"]::placeholder {
            color: #aaaaaa; /* Placeholder text color */
        }
        .movie-cards {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .card {
            background-color: #1e1e1e;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            margin: 15px;
            padding: 20px;
            width: 200px;
            text-align: center;
            transition: transform 0.2s;
        }
        .card:hover {
            transform: scale(1.05);
        }
        .card img {
            width: 100%;
            border-radius: 10px;
        }
        .card h3 {
            margin: 10px 0 0 0;
            font-size: 18px;
            color: #1db954;
        }
        .header-buttons {
            position: absolute;
            top: 20px;
            right: 20px;
        }
        .header-buttons .btn {
            margin-left: 10px;
        }
        .add-to-playlist-btn {
            margin-top: 10px;
            padding: 5px 10px;
            font-size: 14px;
        }
        .alert-box {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: black;
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
        }
    </style>
</head>
<body>

<div class="header">
    <h1> Movie Search</h1>
    <div class="header-buttons">
        <span style="color: black;"><strong>Welcome {{ username }}!</strong> </span> <!-- Display the username here -->
        <button type="button" class="btn btn-warning" onclick="togglePlaylist()">PlayList</button>
        <button type="button" class="btn btn-danger" onclick="logout()">Logout</button>
    </div>
</div>

<div class="search-container">
    <input type="text" id="search" placeholder="Search for movies..." onkeyup="searchMovies()">
</div>

<div class="movie-cards" id="movie-cards">
    <!-- Movie cards will be generated by JavaScript -->
</div>

<div class="alert-box" id="alert-box">
    <!-- Alert messages will be shown here -->
</div>

<script>
    const API_KEY = '6af47356';

    async function fetchMovies(query, page = 1) {
        const response = await fetch(`http://www.omdbapi.com/?s=${query}&apikey=${API_KEY}&page=${page}`);
        const data = await response.json();
        return data.Search;
    }

    async function fetchMultiplePages(query, numPages) {
        const allMovies = [];
        for (let i = 1; i <= numPages; i++) {
            const movies = await fetchMovies(query, i);
            if (movies) {
                allMovies.push(...movies);
            }
            if (allMovies.length >= 12) {
                break;
            }
        }
        return allMovies.slice(0, 12);
    }

    function displayMovies(movies) {
        const movieCards = document.getElementById('movie-cards');
        movieCards.innerHTML = '';
        movies.forEach(movie => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <img src="${movie.Poster}" alt="${movie.Title}">
                <h3>${movie.Title}</h3>
                <button type="button" class="btn btn-success add-to-playlist-btn" onclick="addToPlaylist('${movie.Title}', '${movie.Poster}')">Add to PlayList</button>
            `;
            movieCards.appendChild(card);
        });
    }

    async function searchMovies() {
        const input = document.getElementById('search');
        const filter = input.value.toLowerCase();
        const movies = await fetchMultiplePages(filter, 2); // Fetch 2 pages to ensure getting 12 movies
        if (movies) {
            displayMovies(movies);
        }
    }

    // Function to add a movie to the playlist
<!--    function addToPlaylist(title, poster) {-->
<!--        let playlist = JSON.parse(localStorage.getItem('playlist')) || [];-->
<!--        const movieExists = playlist.some(movie => movie.title === title);-->

<!--        if (movieExists) {-->
<!--            showAlert('Already in the playlist');-->
<!--        } else {-->
<!--            playlist.push({ title, poster });-->
<!--            localStorage.setItem('playlist', JSON.stringify(playlist));-->
<!--            showAlert('Added to the playlist');-->
<!--        }-->
<!--    }-->
// Function to add a movie to the playlist
function addToPlaylist(title, poster) {
    const formData = new FormData();
    formData.append('title', title);
    formData.append('poster', poster);

    fetch('/add-to-playlist/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')  // Include the CSRF token in the request headers
        },
        body: formData
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        }
        throw new Error('Failed to add movie to playlist.');
    })
    .then(data => {
        showAlert(data.message);
    })
    .catch(error => {
        showAlert(error.message);
    });
}

// Function to retrieve CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}


    // Function to show alerts
    function showAlert(message) {
        const alertBox = document.getElementById('alert-box');
        alertBox.innerText = message;
        alertBox.style.display = 'block';
        setTimeout(() => {
            alertBox.style.display = 'none';
        }, 3000);
    }

    // Fetch and display random movies on initial load
    async function fetchRandomMovies() {
        const randomQuery = 'action'; // or any other keyword you prefer
        const movies = await fetchMultiplePages(randomQuery, 2); // Fetch 2 pages to ensure getting 12 movies
        if (movies) {
            displayMovies(movies);
        }
    }

    // Call the function to fetch and display random movies when the page loads
    window.onload = fetchRandomMovies;

    // Function to toggle the playlist page
    function togglePlaylist() {
        window.location.href = '/playlist/';
    }

    // Logout function to redirect to the logout page
    function logout() {
        window.location.href = '/logout/';
    }
</script>

</body>
</html>
